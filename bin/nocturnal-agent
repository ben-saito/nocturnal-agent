#!/usr/bin/env python3
"""
Nocturnal Agent - Global Command Line Interface
å¤–éƒ¨ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ãªã‚°ãƒ­ãƒ¼ãƒãƒ«CLI
"""

import sys
import os
import subprocess
from pathlib import Path
from datetime import datetime

def find_nocturnal_project():
    """Nocturnal Agentãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢"""
    current = Path.cwd()
    
    # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ä¸Šã«å‘ã‹ã£ã¦æ¤œç´¢
    for path in [current] + list(current.parents):
        if (path / 'nocturnal_simple.py').exists():
            return path
        if (path / 'run_nocturnal_task.py').exists():
            return path
        if (path / 'pyproject.toml').exists() and 'nocturnal-agent' in (path / 'pyproject.toml').read_text():
            return path
    
    return None

def run_command(project_dir, args):
    """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ"""
    # é«˜å“è³ªNocturnal Agentã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ã‚¹
    nocturnal_agent_home = Path("/Users/tsutomusaito/git/nocturnal-agent")
    
    if len(args) == 0:
        # ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
        subprocess.run([sys.executable, str(nocturnal_agent_home / 'nocturnal_simple.py'), '--help'])
        return
    
    command = args[0]
    
    if command in ['add-task', 'list', 'help']:
        # ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚³ãƒãƒ³ãƒ‰ - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®nocturnal_simple.pyã‚’ä½¿ç”¨
        os.chdir(project_dir)
        subprocess.run([sys.executable, 'nocturnal_simple.py'] + args)
    
    elif command == 'run':
        # ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ - å¸¸ã«é«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
        print("ğŸ”¥ é«˜å“è³ªNocturnal Agentã‚·ã‚¹ãƒ†ãƒ ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™...")
        
        # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’é«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ã«ã‚³ãƒ”ãƒ¼
        local_tasks_file = project_dir / 'nocturnal_tasks' / 'tasks.json'
        agent_tasks_file = nocturnal_agent_home / 'nocturnal_tasks' / 'tasks.json'
        
        if local_tasks_file.exists():
            import shutil
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
            if agent_tasks_file.exists():
                backup_file = nocturnal_agent_home / 'nocturnal_tasks' / f'tasks_backup_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
                shutil.copy2(agent_tasks_file, backup_file)
                print(f"ğŸ“‹ æ—¢å­˜ã‚¿ã‚¹ã‚¯ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: {backup_file.name}")
            
            # ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¹ã‚¯ã‚’é«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ã«ã‚³ãƒ”ãƒ¼
            shutil.copy2(local_tasks_file, agent_tasks_file)
            print(f"ğŸ“‚ ã‚¿ã‚¹ã‚¯ã‚’é«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ã«ã‚³ãƒ”ãƒ¼å®Œäº†")
        
        # é«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ã§å®Ÿè¡Œ
        os.chdir(nocturnal_agent_home)
        result = subprocess.run([sys.executable, 'run_nocturnal_task.py'])
        
        # å®Ÿè¡Œå¾Œã€çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚³ãƒ”ãƒ¼ãƒãƒƒã‚¯
        if agent_tasks_file.exists():
            shutil.copy2(agent_tasks_file, local_tasks_file)
            print("ğŸ“‹ å®Ÿè¡Œçµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ ")
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚³ãƒ”ãƒ¼
        agent_output_dir = nocturnal_agent_home / 'nocturnal_output'
        local_output_dir = project_dir / 'nocturnal_output'
        local_output_dir.mkdir(exist_ok=True)
        
        if agent_output_dir.exists():
            # æœ€æ–°ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            for file in agent_output_dir.glob('*'):
                if file.is_file():
                    shutil.copy2(file, local_output_dir / file.name)
            print(f"ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚³ãƒ”ãƒ¼å®Œäº†")
        
        print("âœ¨ é«˜å“è³ªNocturnal Agentã‚·ã‚¹ãƒ†ãƒ ã§ã®å®Ÿè¡Œå®Œäº†ï¼")
        return result
    
    elif command == 'status':
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ç¢ºèª
        print("ğŸ“Š Nocturnal Agent ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹")
        print(f"ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {project_dir}")
        
        # ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        tasks_file = project_dir / 'nocturnal_tasks' / 'tasks.json'
        if tasks_file.exists():
            print("âœ… ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«: å­˜åœ¨")
            subprocess.run([sys.executable, 'nocturnal_simple.py', 'list'])
        else:
            print("ğŸ“‹ ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«: ãªã—")
        
        # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
        output_dir = project_dir / 'nocturnal_output'
        if output_dir.exists():
            files = list(output_dir.glob('*'))
            print(f"ğŸ“¤ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: {len(files)}å€‹")
        else:
            print("ğŸ“¤ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: ãªã—")
    
    elif command == 'init':
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
        print("ğŸŒ™ Nocturnal Agent ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ä¸­...")
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        (project_dir / 'nocturnal_tasks').mkdir(exist_ok=True)
        (project_dir / 'nocturnal_output').mkdir(exist_ok=True)
        (project_dir / 'logs').mkdir(exist_ok=True)
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        config_dir = project_dir / 'config'
        config_dir.mkdir(exist_ok=True)
        
        print("âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–å®Œäº†")
        print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
        print("   nocturnal-agent add-task -t 'ã‚¿ã‚¹ã‚¯å†…å®¹' -p high")
        print("   nocturnal-agent run")
    
    else:
        print(f"âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {command}")
        print("ğŸ’¡ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:")
        print("   nocturnal-agent add-task -t 'ã‚¿ã‚¹ã‚¯å†…å®¹' -p high")
        print("   nocturnal-agent list")
        print("   nocturnal-agent run")
        print("   nocturnal-agent status")
        print("   nocturnal-agent init")

def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    args = sys.argv[1:]
    
    # initã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
    if len(args) > 0 and args[0] == 'init':
        current_dir = Path.cwd()
        print(f"ğŸŒ™ Nocturnal Agent [{current_dir.name}]")
        print("ğŸŒ™ Nocturnal Agent ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ä¸­...")
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        (current_dir / 'nocturnal_tasks').mkdir(exist_ok=True)
        (current_dir / 'nocturnal_output').mkdir(exist_ok=True)
        (current_dir / 'logs').mkdir(exist_ok=True)
        
        # è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        config_dir = current_dir / 'config'
        config_dir.mkdir(exist_ok=True)
        
        # é«˜å“è³ªNocturnal Agentã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        nocturnal_agent_dir = Path("/Users/tsutomusaito/git/nocturnal-agent")
        
        # nocturnal_simple.pyã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
        original_script = nocturnal_agent_dir / 'nocturnal_simple.py'
        target_script = current_dir / 'nocturnal_simple.py'
        
        if original_script.exists():
            import shutil
            shutil.copy2(original_script, target_script)
            print(f"âœ… nocturnal_simple.py ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")
        else:
            print(f"âš ï¸ é«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {original_script}")
        
        print(f"ğŸ”¥ é«˜å“è³ªNocturnal Agentã‚·ã‚¹ãƒ†ãƒ ã¸ã®å‚ç…§ã‚’è¨­å®šã—ã¾ã—ãŸ")
        print(f"ğŸ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹: {nocturnal_agent_dir}")
        
        print("âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–å®Œäº†")
        print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
        print("   nocturnal-agent add-task -t 'ã‚¿ã‚¹ã‚¯å†…å®¹' -p high")
        print("   nocturnal-agent run")
        return
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢
    project_dir = find_nocturnal_project()
    
    if not project_dir:
        print("âŒ Nocturnal Agentãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print("ğŸ’¡ ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:")
        print("   1. Nocturnal Agentãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•")
        print("   2. nocturnal-agent init ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–")
        sys.exit(1)
    
    print(f"ğŸŒ™ Nocturnal Agent [{project_dir.name}]")
    
    try:
        run_command(project_dir, args)
    except KeyboardInterrupt:
        print("\nâš ï¸ å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()