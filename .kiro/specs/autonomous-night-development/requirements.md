# 要件定義書

## はじめに

この機能は、開発者が寝ている間に自動的に開発作業を進める自律夜間開発システムを実装します。システムは、ローカル LLM（LM Studio）を主要な知能として活用し、既存の認証済みコーディングエージェントと統合し、Obsidian ベースのコンテキスト管理を通じてプロジェクト固有のコーディングパターンを維持することで、コスト効率性に焦点を当てています。システムは、包括的なチェック、バックアップメカニズム、フィードバックループを持つ多段階レビュープロセスを通じて安全性を確保します。

## 要件

### 要件 1: 夜間自動実行

**ユーザーストーリー:** 開発者として、夜間時間帯（午後 10 時から午前 6 時）にシステムが自動的に開発タスクを実行することで、手動介入なしに完了した開発作業で目覚めたい。

#### 受入条件

1. システム時刻が 22:00 に達したとき、システムは自動的にタスク実行を開始すること
2. 夜間実行がアクティブなとき、システムは人間の介入なしに 06:00 まで継続実行すること
3. 安全性チェックが失敗したとき、システムは実行を停止し、失敗をログに記録すること
4. 実行期間が終了したとき、システムは完了したすべての作業の包括的なレポートを生成すること
5. 実行中に重大なエラーが発生した場合、システムは自動的にバックアップを作成し、変更をロールバックすること
6. 1 夜あたりの最大変更数が 10 を超えないよう制限すること

### 要件 2: 品質基準管理

**ユーザーストーリー:** 開発者として、システムが自動的にコード品質基準を維持することで、品質を損なうことなくプロジェクト要件を満たすすべての生成コードを得たい。

#### 受入条件

1. コードが生成されたとき、システムは品質スコア閾値 0.85 に対してそれを評価すること
2. 品質スコアが 0.85 未満の場合、システムは改善サイクルを開始すること（最大 3 回の試行）
3. 3 回の試行後に改善サイクルが失敗したとき、システムはタスクを朝の承認キューに送ること
4. 品質基準が満たされたとき、システムは自動的に変更を適用し、次のタスクに継続すること
5. コードがプロジェクトの一貫性ルールに違反した場合、システムは自動的に違反を修正するか、レビューのためにフラグを立てること
6. 品質スコア、統一性スコア、テストカバレッジが測定・記録されること

### 要件 3: マルチエージェント連携

**ユーザーストーリー:** 開発者として、システムが複数のコーディングエージェントを知的に調整することで、コスト効率性を維持しながら利用可能な最良のツールを活用したい。

#### 受入条件

1. システムが開始されたとき、利用可能なコーディングエージェント（Claude Code、GitHub Copilot、Codex 等）を自動検出すること
2. 複数のエージェントが利用可能なとき、システムは認証状態と機能に基づいて優先順位を付けること
3. プライマリエージェントが失敗した場合、システムは 30 秒以内に代替エージェントに自動的にフォールバックすること
4. API 制限に達したとき、システムは代替エージェントまたはローカル処理に切り替えること
5. すべての外部エージェントが失敗した場合、システムはローカル LLM 処理のみで継続すること
6. エージェント検出成功率とフォールバック成功率が記録されること

### 要件 4: プロジェクトコンテキスト永続化

**ユーザーストーリー:** 開発者として、システムがプロジェクト固有のパターンを学習・維持することで、生成されるコードが既存のコードベース規約と一貫性を保ちたい。

#### 受入条件

1. プロジェクトを分析するとき、システムはコーディングパターン、命名規則、アーキテクチャ決定を抽出すること
2. 新しいコードを生成するとき、システムは学習したパターンを適用して一貫性を維持すること
3. 成功した実装が発生したとき、システムは Obsidian 知識ベースにパターンを保存すること
4. 失敗が発生したとき、システムは原因を分析し、学習データを更新すること
5. 一貫性違反が検出された場合、システムは自動修正または提案を提供すること
6. データは Markdown + YAML frontmatter 形式で構造化されること

### 要件 5: 統一性エンジン

**ユーザーストーリー:** 開発者として、コーディング統一性の自動維持により、プロジェクト全体で一貫したコード品質を保ちたい。

#### 受入条件

1. 既存コードパターンが自動的に抽出されること
2. リアルタイムで統一性チェックが実行されること
3. 違反時に自動修正提案が提供されること
4. 統一性スコア 0.85 以上が維持されること
5. 学習型ルールによりプロジェクト固有パターンが自動抽出されること

### 要件 6: 安全性とセキュリティ

**ユーザーストーリー:** 開発者として、包括的な安全メカニズムにより、夜間実行がコードベースやシステムに損害を与えないことを確保したい。

#### 受入条件

1. 夜間実行を開始するとき、システムは影響を受けるすべてのリポジトリの完全なバックアップを作成すること
2. 危険な操作が検出されたとき、システムは実行をブロックし、試行をログに記録すること
3. ファイル変更が安全制限を超えた場合、システムは停止し、手動承認を要求すること
4. ロールバックが必要なとき、システムは Git reset --hard を使用して以前の状態を復元すること
5. システムリソースが CPU 80%またはメモリ 8GB を超えた場合、システムは実行を調整または一時停止すること
6. 危険コマンド（削除・フォーマット系）が自動的にブロックされること

### 要件 7: コスト効率的運用

**ユーザーストーリー:** 開発者として、コスト効率的な運用により、システムが定期使用において経済的に実行可能であることを確保したい。

#### 受入条件

1. タスクを処理するとき、システムは有料 API よりもローカル LLM を優先すること
2. 外部 API が使用されるとき、システムは月額予算制限$10 に対して使用量を追跡すること
3. 予算制限に近づいた場合、システムは無料の代替手段に切り替えること
4. コストを最適化するとき、システムは品質基準 0.85 以上を維持すること
5. 無料リソースが枯渇した場合、システムは残りのタスクを手動完了のためにキューに入れること
6. 無料ツール利用率 90%以上を維持すること

### 要件 8: 並行実行機能

**ユーザーストーリー:** 開発者として、並行実行機能により、夜間時間中に複数の開発ブランチで同時に作業できることを望む。

#### 受入条件

1. 複数のタスクがキューに入っているとき、システムは最大 5 つの並行ブランチを実行すること
2. 品質予測が異なるとき、システムは異なる信頼度レベルに対して別々のブランチを作成すること
3. 高信頼度タスクが存在する場合、システムはメインブランチ統合のためにそれらを優先すること
4. 実験的タスクが実行されるとき、システムはそれらを別々のブランチに分離すること
5. 並行実行の競合が発生した場合、システムは自動的に解決するか、レビューのためにフラグを立てること
6. 動的品質閾値により品質レベルに応じた自動分岐実行が行われること

### 要件 9: 学習と改善システム

**ユーザーストーリー:** 開発者として、継続的な学習と改善により、システムが時間とともに向上し、プロジェクト知識を維持することを望む。

#### 受入条件

1. タスクが完了したとき、システムは成功パターン、失敗原因、改善戦略を Obsidian に記録すること
2. 類似のタスクに遭遇したとき、システムは以前に学習した解決策を適用すること
3. プロジェクト横断的なパターンが現れたとき、システムは再利用可能な知識テンプレートを作成すること
4. 知識の競合が発生した場合、システムは一般的なパターンよりもプロジェクト固有のパターンを優先すること
5. 知識ベースが成長するとき、システムは検索可能で構造化されたドキュメントを維持すること
6. 改善サイクルの成功率と品質スコア向上トレンドが追跡されること
